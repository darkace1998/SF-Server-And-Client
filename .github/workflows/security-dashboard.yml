name: Security Dashboard

on:
  workflow_run:
    workflows: ["Security Analysis", "CodeQL Security Analysis", "Continuous Integration", "Code Quality"]
    types: [completed]
  schedule:
    # Generate security dashboard weekly
    - cron: '0 6 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  security-events: read

jobs:
  security-dashboard:
    name: Generate Security Dashboard
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'failure' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download recent workflow artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Get recent workflow runs
          const workflows = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'security.yml',
            per_page: 1
          });
          
          console.log('Recent security workflow runs found:', workflows.data.total_count);
          
          // Create dashboard data
          const dashboardData = {
            lastUpdate: new Date().toISOString(),
            repository: `${context.repo.owner}/${context.repo.repo}`,
            securityStatus: 'monitoring',
            workflows: {
              security: workflows.data.workflow_runs[0]?.conclusion || 'unknown',
              codeql: 'enabled',
              dependencies: 'monitored'
            }
          };
          
          fs.writeFileSync('security-dashboard.json', JSON.stringify(dashboardData, null, 2));

    - name: Generate security report
      run: |
        echo "# 🛡️ Security Dashboard" > SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "*Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "## 📊 Security Status Overview" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "| Component | Status | Last Check |" >> SECURITY_DASHBOARD.md
        echo "|-----------|--------|------------|" >> SECURITY_DASHBOARD.md
        echo "| CodeQL Analysis | ✅ Active | Daily |" >> SECURITY_DASHBOARD.md
        echo "| Dependency Scanning | ✅ Active | Weekly |" >> SECURITY_DASHBOARD.md
        echo "| Secret Scanning | ✅ Active | Every commit |" >> SECURITY_DASHBOARD.md
        echo "| Static Analysis | ✅ Active | Every commit |" >> SECURITY_DASHBOARD.md
        echo "| Auto-formatting | ✅ Active | Every PR |" >> SECURITY_DASHBOARD.md
        echo "| Pre-commit Checks | ✅ Active | Every PR |" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "## 🔧 Security Tools Enabled" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "### Static Analysis" >> SECURITY_DASHBOARD.md
        echo "- **CodeQL**: Advanced semantic analysis for security vulnerabilities" >> SECURITY_DASHBOARD.md
        echo "- **Microsoft.CodeAnalysis.NetAnalyzers**: .NET security and quality rules" >> SECURITY_DASHBOARD.md
        echo "- **SecurityCodeScan**: Security-focused static analysis" >> SECURITY_DASHBOARD.md
        echo "- **SonarAnalyzer**: Code quality and security analysis" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "### Dependency Management" >> SECURITY_DASHBOARD.md
        echo "- **Dependabot**: Automated security updates" >> SECURITY_DASHBOARD.md
        echo "- **Vulnerability Scanning**: Regular checks for known CVEs" >> SECURITY_DASHBOARD.md
        echo "- **Package Auditing**: NuGet package security verification" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "### Development Workflow" >> SECURITY_DASHBOARD.md
        echo "- **Pre-commit Hooks**: Security checks before code integration" >> SECURITY_DASHBOARD.md
        echo "- **Auto-formatting**: Consistent code style enforcement" >> SECURITY_DASHBOARD.md
        echo "- **Secret Detection**: Pattern-based secret scanning" >> SECURITY_DASHBOARD.md
        echo "- **SARIF Output**: Standardized security findings format" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "## 📋 Security Configuration" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "### Analyzer Rules" >> SECURITY_DASHBOARD.md
        echo "- Security rules (CA5xxx): **Error level**" >> SECURITY_DASHBOARD.md
        echo "- Cryptography rules: **Error level**" >> SECURITY_DASHBOARD.md
        echo "- SQL injection detection: **Error level**" >> SECURITY_DASHBOARD.md
        echo "- Input validation: **Warning level**" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "### Workflow Schedule" >> SECURITY_DASHBOARD.md
        echo "- **CodeQL**: Weekly (Sundays 3 AM UTC)" >> SECURITY_DASHBOARD.md
        echo "- **Security Analysis**: Daily (2 AM UTC)" >> SECURITY_DASHBOARD.md
        echo "- **Dependency Updates**: Weekly (Mondays)" >> SECURITY_DASHBOARD.md
        echo "- **Dashboard Update**: Weekly (Mondays 6 AM UTC)" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "## 🔍 Quick Security Audit" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "\`\`\`bash" >> SECURITY_DASHBOARD.md
        echo "# Run local security checks" >> SECURITY_DASHBOARD.md
        echo "dotnet restore SF-Server/SF-Server.csproj" >> SECURITY_DASHBOARD.md
        echo "dotnet build SF-Server/SF-Server.csproj --configuration Release" >> SECURITY_DASHBOARD.md
        echo "dotnet list SF-Server/packages --vulnerable" >> SECURITY_DASHBOARD.md
        echo "dotnet format SF-Server/SF-Server.csproj --verify-no-changes" >> SECURITY_DASHBOARD.md
        echo "\`\`\`" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "## 📞 Security Contact" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        echo "- **Security Policy**: [SECURITY.md](SECURITY.md)" >> SECURITY_DASHBOARD.md
        echo "- **Vulnerability Reporting**: GitHub Security tab" >> SECURITY_DASHBOARD.md
        echo "- **Maintainer**: Repository owner" >> SECURITY_DASHBOARD.md
        echo "" >> SECURITY_DASHBOARD.md
        
        echo "---" >> SECURITY_DASHBOARD.md
        echo "*This dashboard is automatically generated by GitHub Actions*" >> SECURITY_DASHBOARD.md

    - name: Upload dashboard
      uses: actions/upload-artifact@v4
      with:
        name: security-dashboard
        path: |
          SECURITY_DASHBOARD.md
          security-dashboard.json

    - name: Summary
      run: |
        echo "## 🛡️ Security Dashboard Generated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Security monitoring status has been updated and documented." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Key Features:**" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ CodeQL advanced analysis enabled" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Automated dependency updates configured" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Comprehensive secret scanning active" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Pre-commit security checks enforced" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Auto-formatting for consistent code style" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The security dashboard artifact contains detailed information about all enabled security features." >> $GITHUB_STEP_SUMMARY